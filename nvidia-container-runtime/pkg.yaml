name: nvidia-container-runtime
variant: alpine
shell: /toolchain/bin/bash
dependencies:
  - stage: base
steps:
  - sources:
      - url: https://gitlab.com/nvidia/container-toolkit/container-toolkit/-/archive/v1.7.0/container-toolkit-v1.8.1.tar.gz
        destination: container-toolkit.tar.gz
        sha256: df9929679e2bdd0702580fe71eb84597a7b92c47be289c346be158c3e1b42343
        sha512: e3fcd2e7698fb9156ca33157b292eac10c38163a6b736b75f16f532013fce093f154c1233dba3f379307bc6f6e0331b038839e6365924945e72875e4891c84dc
      - url: https://github.com/NVIDIA/libnvidia-container/archive/refs/tags/v1.8.1.tar.gz
        destination:  libnvidia-container.tar.gz
        sha256: 0ba2f3b9fa45b7369061e572195e617249aafa7f9cf32a3999d17f2a1a4b7cd6
        sha512: 8c41c5ec14b7cafa3ae05313dee417207c14d19885c7854b8f9598cc3166f836ff542d7c8d1490a838d691d1dde81ff1929f41886cbe3b2d8bc317c2888c2d02
    env:
      GOPATH: /go
    prepare:
      - |
        apk add bmake bsd-compat-headers groff libelf patch rpcgen which

        mkdir -p /etc/ssl/certs/
        ln -s /toolchain/etc/ssl/certs/ca-certificates /etc/ssl/certs/ca-certificates

        mkdir -p ${GOPATH}/src/gitlab.com/nvidia/container-toolkit

        tar -xzf container-toolkit.tar.gz --strip-components=1 -C ${GOPATH}/src/gitlab.com/nvidia/container-toolkit

        mkdir  libnvidia-container
        tar -xzf  libnvidia-container.tar.gz --strip-components=1 -C  libnvidia-container
    build:
      - |
        export PATH=${PATH}:${TOOLCHAIN}/go/bin

        lsb_release() { echo "alpine"; }; export -f lsb_release

        cd libnvidia-container

        cat mk/elftoolchain.mk

        patch -Np1 -i "/pkg/fix_git_rev_unavail.patch"
        patch -Np1 -i "/pkg/fix_libelf_so_name.patch"
        patch -Np1 -i "/pkg/fix_elftoolchain.patch"

        mkdir /rootfs
        WITH_NVCGO=no WITH_LIBELF=no WITH_TIRPC=no WITH_SECCOMP=no DESTDIR=/rootfs make install -j "$(nproc)" prefix=/usr/local COMPILER=/toolchain/bin/gcc REVISION=xyz 

        cd ${GOPATH}/src/gitlab.com/nvidia/container-toolkit/cmd/nvidia-container-runtime

        go build .
    install:
      - |
        mkdir -p /rootfs/usr/local/bin

        cd ${GOPATH}/src/gitlab.com/nvidia/container-toolkit/cmd/nvidia-container-runtime

        cp ./nvidia-container-runtime /rootfs/usr/local/bin/nvidia-container-runtime
        chmod +x /rootfs/usr/local/bin/nvidia-container-runtime
finalize:
  - from: /rootfs
    to: /rootfs
  - from: /pkg/manifest.yaml
    to: /
  - from: /pkg/nvidia-container-runtime.part
    to: /rootfs/etc/cri/conf.d/nvidia-container-runtime.part
  - from: /pkg/nvidia-container-runtime.toml
    to: /rootfs/etc/nvidia-container-runtime/config.toml
